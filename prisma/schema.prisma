generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              String           @id @default(cuid())
  clerkUserId     String           @unique @map("clerk_user_id")
  tokenBalance    Int              @default(0) @map("token_balance")
  lastFreeFlipAt  DateTime?        @map("last_free_flip_at")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  paymentIntents  Payment[]
  paymentAccounts PaymentAccount[]
  readings        SavedCard[]
  subscriptions   Subscription[]
  tokenPurchases  TokenPurchase[]

  @@map("user")
}

model PaymentAccount {
  id                     String          @id @default(cuid())
  clerkUserId            String          @map("clerk_user_id")
  provider               PaymentProvider @map("provider")
  providerCustomerId     String          @map("provider_customer_id")
  defaultPaymentMethodId String?         @map("default_payment_method_id")
  createdAt              DateTime        @default(now()) @map("created_at")
  updatedAt              DateTime        @updatedAt @map("updated_at")
  user                   User            @relation(fields: [clerkUserId], references: [clerkUserId], onDelete: Cascade)

  @@unique([clerkUserId, provider])
  @@unique([provider, providerCustomerId])
  @@map("payment_account")
}

model Package {
  id             String          @id @default(cuid())
  type           PackageType     @unique @map("type")
  nameTh         String          @map("name_th")
  nameEn         String          @map("name_en")
  priceThb       Decimal         @map("price_thb")
  stripePriceId  String?         @map("stripe_price_id")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  subscriptions  Subscription[]
  tokenPurchases TokenPurchase[]

  @@map("package")
}

model Payment {
  id             String          @id @default(cuid())
  clerkUserId    String          @map("clerk_user_id")
  paymentMethod  PaymentMethod   @map("payment_method")
  paymentStatus  PaymentStatus   @default(PENDING) @map("payment_status")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  card_details   Json?
  user           User            @relation(fields: [clerkUserId], references: [clerkUserId], onDelete: Cascade)
  subscriptions  Subscription[]
  tokenPurchases TokenPurchase[]

  @@map("payment")
}

model Subscription {
  id                      String          @id @default(cuid())
  packageId               String          @map("package_id")
  clerkUserId             String          @map("clerk_user_id")
  paymentProvider         PaymentProvider @map("payment_provider")
  providerSubscriptionId  String?         @map("provider_subscription_id")
  providerMetadata        Json?           @map("provider_metadata")
  startTime               DateTime        @map("start_time")
  endTime                 DateTime        @map("end_time")
  isAutoRenew             Boolean         @default(false) @map("auto_renew")
  pricePaidThb            Decimal         @map("price_paid_thb")
  paymentId               String          @map("payment_id")
  createdAt               DateTime        @default(now()) @map("created_at")
  updatedAt               DateTime        @updatedAt @map("updated_at")
  autoRenewDisabledAt     DateTime?       @map("auto_renew_disabled_at")
  is_voided               Boolean         @default(false)
  voided_at               DateTime?
  auto_renew_card_details Json?
  user                    User            @relation(fields: [clerkUserId], references: [clerkUserId], onDelete: Cascade)
  package                 Package         @relation(fields: [packageId], references: [id])
  payment                 Payment         @relation(fields: [paymentId], references: [id])

  @@unique([clerkUserId, packageId])
  @@unique([paymentProvider, providerSubscriptionId])
  @@map("subscription")
}

model TokenPurchase {
  id             String   @id @default(cuid())
  clerkUserId    String   @map("clerk_user_id")
  packageId      String   @map("package_id")
  pricePaidThb   Decimal  @map("price_paid_thb")
  tokensReceived Int      @map("tokens_received")
  paymentId      String   @map("payment_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  user           User     @relation(fields: [clerkUserId], references: [clerkUserId], onDelete: Cascade)
  package        Package  @relation(fields: [packageId], references: [id])
  payment        Payment  @relation(fields: [paymentId], references: [id])

  @@map("token_purchase")
}

model SavedCard {
  id          String   @id @default(cuid())
  clerkUserId String   @map("clerk_user_id")
  cardId      String   @map("card_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  card        Card     @relation(fields: [cardId], references: [id])
  user        User     @relation(fields: [clerkUserId], references: [clerkUserId], onDelete: Cascade)

  @@map("saved_card")
}

model Artist {
  id             String           @id @default(cuid())
  fullName       String           @map("full_name")
  avatarUrl      String?          @map("avatar_url")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  arts           Art[]
  artist_content artist_content[]
  products       Product[]

  @@map("artist")
}

model Art {
  id        String   @id @default(cuid())
  imageUrl  String   @map("image_url")
  artistId  String   @map("artist_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  artist    Artist   @relation(fields: [artistId], references: [id])
  cards     Card[]

  @@map("art")
}

model Card {
  id          String        @id @default(cuid())
  periodStart DateTime      @map("period_start") @db.Timestamptz(6)
  periodEnd   DateTime      @map("period_end") @db.Timestamptz(6)
  artId       String?       @map("art_id")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  art         Art?          @relation(fields: [artId], references: [id])
  cardContent CardContent[]
  readings    SavedCard[]

  @@unique([periodStart, periodEnd])
  @@map("card")
}

model CardContent {
  id           String @id @default(cuid())
  cardId       String @map("card_id")
  languageCode String @map("language_code")
  contentJson  Json   @map("content_json")
  cards        Card   @relation(fields: [cardId], references: [id])

  @@unique([cardId, languageCode])
  @@map("card_content")
}

model Product {
  id             String           @id @default(cuid())
  imageUrl       String           @map("image_url")
  priceThb       Decimal          @map("price_thb")
  artistId       String           @map("artist_id")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  artist         Artist           @relation(fields: [artistId], references: [id])
  productContent ProductContent[]

  @@map("product")
}

model ProductContent {
  id           String   @id @default(cuid())
  languageCode String   @map("language_code")
  title        String   @map("title")
  description  String   @map("description")
  productId    String   @map("product_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  product      Product  @relation(fields: [productId], references: [id])

  @@unique([languageCode, productId])
  @@map("product_content")
}

model artist_content {
  id            String   @id
  artist_id     String
  language_code String
  specialties   String[]
  description   String?
  created_at    DateTime @default(now())
  updated_at    DateTime
  artist        Artist   @relation(fields: [artist_id], references: [id])

  @@unique([language_code, artist_id])
}

enum PaymentProvider {
  STRIPE
  OMISE
}

enum PackageType {
  MONTHLY
  YEARLY
  FLIP_TOKEN_1
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  PROMPT_PAY
  TRUE_MONEY
}
