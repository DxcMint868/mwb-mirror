// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String    @id @default(cuid())
  clerkUserId    String    @unique @map("clerk_user_id")
  tokenBalance   Int       @default(0) @map("token_balance")
  lastFreeFlipAt DateTime? @map("last_free_flip_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  readings        SavedCard[]
  subscriptions   Subscription[]
  tokenPurchases  TokenPurchase[]
  paymentAccounts PaymentAccount[]
  paymentIntents  Payment[]

  @@map("user")
}

enum PaymentProvider {
  STRIPE
  OMISE
}

model PaymentAccount {
  id                     String          @id @default(cuid())
  clerkUserId            String          @map("clerk_user_id")
  provider               PaymentProvider @map("provider")
  providerCustomerId     String          @map("provider_customer_id")
  defaultPaymentMethodId String?         @map("default_payment_method_id")
  createdAt              DateTime        @default(now()) @map("created_at")
  updatedAt              DateTime        @updatedAt @map("updated_at")

  user User @relation(fields: [clerkUserId], references: [clerkUserId])

  @@unique([clerkUserId, provider])
  @@unique([provider, providerCustomerId])
  @@map("payment_account")
}

enum PackageType {
  MONTHLY
  YEARLY
  FLIP_TOKEN_1 // Purchase 1 flip token
}

model Package {
  id            String      @id @default(cuid())
  type          PackageType @unique @map("type")
  nameTh        String      @map("name_th")
  nameEn        String      @map("name_en")
  priceThb      Decimal     @map("price_thb") // pricing in THB
  stripePriceId String?     @map("stripe_price_id") // Stripe Price ID for subscription packages
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  subscriptions  Subscription[]
  tokenPurchases TokenPurchase[]

  @@map("package")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  PROMPT_PAY
  TRUE_MONEY
}

model Payment {
  id            String        @id @default(cuid())
  clerkUserId   String        @map("clerk_user_id")
  paymentMethod PaymentMethod @map("payment_method")
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  user           User            @relation(fields: [clerkUserId], references: [clerkUserId])
  subscriptions  Subscription[]
  tokenPurchases TokenPurchase[]

  @@map("payment")
}

model Subscription {
  id                     String          @id @default(cuid())
  packageId              String          @map("package_id")
  clerkUserId            String          @map("clerk_user_id")
  paymentProvider        PaymentProvider @map("payment_provider") // Which provider manages this subscription
  providerSubscriptionId String?         @map("provider_subscription_id") // Provider's subscription ID (e.g., Stripe sub_xxx, Omise subsc_xxx)
  providerMetadata       Json?           @map("provider_metadata") // Provider-specific metadata
  startTime              DateTime        @map("start_time")
  endTime                DateTime        @map("end_time")
  isAutoRenew            Boolean         @default(false) @map("auto_renew")
  pricePaidThb           Decimal         @map("price_paid_thb")
  paymentId              String          @map("payment_id")
  autoRenewDisabledAt    DateTime?       @map("auto_renew_disabled_at") // Time of auto-renewal disabling (if disabled)
  createdAt              DateTime        @default(now()) @map("created_at") // Time of purchase
  updatedAt              DateTime        @updatedAt @map("updated_at")

  payment Payment @relation(fields: [paymentId], references: [id])
  package Package @relation(fields: [packageId], references: [id])
  user    User    @relation(fields: [clerkUserId], references: [clerkUserId])

  @@unique([clerkUserId, packageId])
  @@unique([paymentProvider, providerSubscriptionId]) // Ensure provider subscription IDs are unique
  @@map("subscription")
}

model TokenPurchase {
  id             String   @id @default(cuid())
  clerkUserId    String   @map("clerk_user_id")
  packageId      String   @map("package_id")
  pricePaidThb   Decimal  @map("price_paid_thb")
  tokensReceived Int      @map("tokens_received")
  paymentId      String   @map("payment_id")
  createdAt      DateTime @default(now()) @map("created_at") // Time of purchase
  updatedAt      DateTime @updatedAt @map("updated_at")

  user    User    @relation(fields: [clerkUserId], references: [clerkUserId])
  package Package @relation(fields: [packageId], references: [id])
  payment Payment @relation(fields: [paymentId], references: [id])

  @@map("token_purchase")
}

model SavedCard {
  id          String   @id @default(cuid())
  clerkUserId String   @map("clerk_user_id")
  cardId      String   @map("card_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [clerkUserId], references: [clerkUserId])
  card Card @relation(fields: [cardId], references: [id])

  @@map("saved_card")
}

model Artist {
  id          String   @id @default(cuid())
  fullName    String   @map("full_name")
  avatarUrl   String?  @map("avatar_url")
  description String?  @map("description")
  specialties String[]
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  arts     Art[]
  products Product[]

  @@map("artist")
}

model Art {
  id        String   @id @default(cuid())
  imageUrl  String   @map("image_url")
  artistId  String   @map("artist_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  cards  Card[]
  artist Artist @relation(fields: [artistId], references: [id])

  @@map("art")
}

model Card {
  id          String   @id @default(cuid())
  // date        DateTime  @map("date") @db.Date
  periodStart DateTime @map("period_start") @db.Timestamptz // UTC+7 time
  periodEnd   DateTime @map("period_end") @db.Timestamptz // UTC+7 time
  artId       String?  @map("art_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  art         Art?          @relation(fields: [artId], references: [id])
  cardContent CardContent[]
  readings    SavedCard[]

  @@unique([periodStart, periodEnd])
  @@map("card")
}

model CardContent {
  id           String @id @default(cuid())
  cardId       String @map("card_id")
  languageCode String @map("language_code") // ISO 639-1 code
  contentJson  Json   @map("content_json")

  cards Card @relation(fields: [cardId], references: [id])

  @@unique([cardId, languageCode])
  @@map("card_content")
}

model Product {
  id        String   @id @default(cuid())
  imageUrl  String   @map("image_url")
  priceThb  Decimal  @map("price_thb")
  artistId  String   @map("artist_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  artist         Artist           @relation(fields: [artistId], references: [id])
  productContent ProductContent[]

  @@map("product")
}

model ProductContent {
  id           String   @id @default(cuid())
  languageCode String   @map("language_code") // ISO 639-1 code
  title        String   @map("title")
  description  String   @map("description")
  productId    String   @map("product_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id])

  @@map("product_content")
}
